#!/usr/bin/env python3
"""Spin each motor one at a time to diagnose stuck wheels.

Usage (no ROS needed):
  python3 test_motors          # test all 4 motors
  python3 test_motors 2        # test only motor_id 2
  python3 test_motors --pwm 60 # test with PWM 60 instead of default 40
"""
import argparse
import sys
import time

# Allow running from workspace root without installing.
sys.path.insert(0, __file__ and __import__('os').path.join(
    __import__('os').path.dirname(__import__('os').path.abspath(__file__)),
    '..', 'raspbot_hw'))

from i2c_car import I2CCar  # type: ignore


MOTOR_NAMES = {
    0: "L1 (front-left)",
    1: "L2 (rear-left)",
    2: "R1 (front-right)",
    3: "R2 (rear-right)",
}


def test_motor(car: I2CCar, motor_id: int, pwm: int, duration: float) -> None:
    name = MOTOR_NAMES.get(motor_id, f"id={motor_id}")
    print(f"\n>>> Motor {motor_id} [{name}]  PWM={pwm} FORWARD for {duration:.1f}s ...")
    car._write_block(0x01, [motor_id, 0, pwm])  # dir=0 forward
    time.sleep(duration)
    car._write_block(0x01, [motor_id, 0, 0])     # stop
    time.sleep(0.3)

    print(f"    Motor {motor_id} [{name}]  PWM={pwm} BACKWARD for {duration:.1f}s ...")
    car._write_block(0x01, [motor_id, 1, pwm])  # dir=1 backward
    time.sleep(duration)
    car._write_block(0x01, [motor_id, 0, 0])     # stop
    time.sleep(0.5)


def main():
    parser = argparse.ArgumentParser(description="Test individual motors via I2C")
    parser.add_argument("motor_id", nargs="?", type=int, default=None,
                        help="Motor ID to test (0-3). Omit to test all.")
    parser.add_argument("--addr", type=lambda x: int(x, 0), default=0x2B,
                        help="I2C address (default 0x2B)")
    parser.add_argument("--bus", type=int, default=1, help="I2C bus (default 1)")
    parser.add_argument("--pwm", type=int, default=40, help="PWM value (default 40)")
    parser.add_argument("--duration", type=float, default=1.5, help="Seconds per direction")
    args = parser.parse_args()

    print(f"Opening I2C bus={args.bus} addr=0x{args.addr:02X} ...")
    car = I2CCar(i2c_bus=args.bus, i2c_addr=args.addr, dry_run=False, protocol='pi5')

    # Stop everything first.
    for mid in range(4):
        car._write_block(0x01, [mid, 0, 0])

    ids = [args.motor_id] if args.motor_id is not None else [0, 1, 2, 3]

    try:
        for mid in ids:
            test_motor(car, mid, args.pwm, args.duration)
        print("\n=== All done. ===")
    except KeyboardInterrupt:
        print("\nInterrupted â€” stopping all motors.")
    finally:
        for mid in range(4):
            car._write_block(0x01, [mid, 0, 0])
        car.close()


if __name__ == "__main__":
    main()
